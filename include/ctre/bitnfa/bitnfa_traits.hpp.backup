#ifndef CTRE_BITNFA_TRAITS_HPP
#define CTRE_BITNFA_TRAITS_HPP

#include "../glushkov_nfa.hpp"

// BitNFA Pattern Analysis Traits
// HEADER-ONLY, NO CIRCULAR DEPENDENCIES
// Safe to include from wrapper.hpp

namespace ctre {
namespace bitnfa {

// Helper: Unwrap captures and sequences to find inner pattern
template <typename T>
struct unwrap_pattern {
    using type = T;
};

// Unwrap capture<N, Content>
template <size_t N, typename Content>
struct unwrap_pattern<capture<N, Content>> {
    using type = typename unwrap_pattern<Content>::type;
};

// Unwrap sequence<Content...> if single element
template <typename Content>
struct unwrap_pattern<sequence<Content>> {
    using type = typename unwrap_pattern<Content>::type;
};

template <typename T>
using unwrap_pattern_t = typename unwrap_pattern<T>::type;

// Helper: Check if pattern (after unwrapping) is an alternation
template <typename T>
constexpr bool is_alternation_pattern() {
    using Unwrapped = unwrap_pattern_t<T>;
    return glushkov::is_select<Unwrapped>::value;
}

// Helper: Check if pattern is a repetition
template <typename T>
constexpr bool is_repetition_pattern() {
    using Unwrapped = unwrap_pattern_t<T>;
    return glushkov::is_repeat<Unwrapped>::value;
}

// BitNFA suitability analysis
// Based on empirical testing from smart_dispatch.hpp:
// - BitNFA WINS on alternations: 15-39% faster
// - BitNFA LOSES on everything else: 6-140x slower
template <typename Pattern>
struct bitnfa_suitability {
    // Is it an alternation pattern?
    static constexpr bool is_alternation = is_alternation_pattern<Pattern>();

    // Is it a repetition pattern?
    static constexpr bool is_repetition = is_repetition_pattern<Pattern>();

    // Should we use BitNFA?
    // YES if: alternation pattern
    // NO if: repetition or other pattern
    static constexpr bool should_use_bitnfa = is_alternation;

    // Strategy name for debugging
    static constexpr const char* strategy_name() {
        if constexpr (should_use_bitnfa) {
            return "BitNFA";
        } else if constexpr (is_repetition) {
            return "SIMD/Glushkov";
        } else {
            return "Glushkov";
        }
    }
};

} // namespace bitnfa
} // namespace ctre

#endif // CTRE_BITNFA_TRAITS_HPP
